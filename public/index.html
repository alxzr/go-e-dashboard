<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>go-e Charger Dashboard</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<div class="container">

    <div class="power-display">
        <span id="power">-</span>
        <span class="unit">kW</span>
    </div>

    <div class="section-title">Charging</div>
    <div class="info-row">

        <div class="info-box">
            <div class="label">Status</div>
            <div id="status" class="badge gray">-</div>
        </div>

        <div class="info-box">
            <div class="label">Charged</div>
            <div class="info-value">
                <span id="energy">-</span> kWh
            </div>
        </div>

        <div class="info-box">
            <div class="label">Configured Phases</div>
            <div class="info-value" id="configured-phases">-</div>
        </div>

        <div class="info-box">
            <div class="label">Configured Current</div>
            <div class="info-value">
                <span id="configured-current">-</span> A
            </div>
        </div>

    </div>

    <div class="section-title">System</div>
    <div class="info-row">

        <div class="info-box">
            <div class="label">WiFi Signal</div>
            <div class="wifi-bars" id="wifi-bars" aria-label="WiFi signal strength">
                <span class="wifi-bar"></span>
                <span class="wifi-bar"></span>
                <span class="wifi-bar"></span>
                <span class="wifi-bar"></span>
                <span class="wifi-bar"></span>
            </div>
            <div class="wifi-text">
                <span id="wifi-signal">-</span> dBm
            </div>
        </div>

        <div class="info-box">
            <div class="label">Type 2 Temp</div>
            <div class="info-value">
                <span id="temp-type2">-</span> °C
            </div>
        </div>

        <div class="info-box">
            <div class="label">Supply Temp</div>
            <div class="info-value">
                <span id="temp-supply">-</span> °C
            </div>
        </div>

    </div>

    <div class="section-title">Controls</div>
    <div class="control-row">
        <div class="control-box">
            <div class="label">Set Phases</div>
            <div class="button-group" id="phase-buttons">
                <button type="button" data-phase="1">1 phase</button>
                <button type="button" data-phase="3">3 phase</button>
            </div>
        </div>

        <div class="control-box">
            <div class="label">Set Current</div>
            <div class="button-group" id="current-buttons">
                <button type="button" data-current="6">6A</button>
                <button type="button" data-current="10">10A</button>
                <button type="button" data-current="12">12A</button>
                <button type="button" data-current="14">14A</button>
                <button type="button" data-current="16">16A</button>
            </div>
        </div>
    </div>
    <div id="control-message" class="control-message hidden"></div>

    <div class="phase-grid">
        <div class="phase" id="phase1">
            <div class="phase-title">L1</div>
            <div><span id="v1">-</span> V</div>
            <div><span id="a1">-</span> A</div>
        </div>
        <div class="phase" id="phase2">
            <div class="phase-title">L2</div>
            <div><span id="v2">-</span> V</div>
            <div><span id="a2">-</span> A</div>
        </div>
        <div class="phase" id="phase3">
            <div class="phase-title">L3</div>
            <div><span id="v3">-</span> V</div>
            <div><span id="a3">-</span> A</div>
        </div>
    </div>

</div>

<script>
function wifiBarsFromDbm(dbm) {
    if (!Number.isFinite(dbm)) return 0;
    if (dbm >= -55) return 5;
    if (dbm >= -62) return 4;
    if (dbm >= -70) return 3;
    if (dbm >= -78) return 2;
    if (dbm >= -86) return 1;
    return 0;
}

function setWifiBars(dbm) {
    const level = wifiBarsFromDbm(dbm);
    const bars = document.querySelectorAll("#wifi-bars .wifi-bar");

    bars.forEach((bar, index) => {
        if (index < level) {
            bar.classList.add("on");
        } else {
            bar.classList.remove("on");
        }
    });
}

function setControlMessage(text, isError = false) {
    const el = document.getElementById("control-message");
    if (!text) {
        el.innerText = "";
        el.className = "control-message hidden";
        return;
    }

    el.innerText = text;
    el.className = "control-message" + (isError ? " error" : "");
}

function setActiveButton(containerId, dataAttr, selectedValue) {
    const buttons = document.querySelectorAll(`#${containerId} button`);
    buttons.forEach(button => {
        if (button.dataset[dataAttr] === String(selectedValue)) {
            button.classList.add("selected");
        } else {
            button.classList.remove("selected");
        }
    });
}

async function postJson(url, payload) {
    const response = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const body = await response.json().catch(() => ({}));
    if (!response.ok) {
        throw new Error(body.error || "Request failed");
    }

    return body;
}

async function setPhases(phases) {
    try {
        await postJson("/api/settings/phases", { phases });
        setControlMessage("");
        await load();
    } catch (error) {
        setControlMessage(error.message, true);
    }
}

async function setCurrent(currentAmp) {
    try {
        await postJson("/api/settings/current", { current_amp: currentAmp });
        setControlMessage("");
        await load();
    } catch (error) {
        setControlMessage(error.message, true);
    }
}

function bindControlEvents() {
    document.querySelectorAll("#phase-buttons button").forEach(button => {
        button.addEventListener("click", () => {
            const phases = Number(button.dataset.phase);
            setPhases(phases);
        });
    });

    document.querySelectorAll("#current-buttons button").forEach(button => {
        button.addEventListener("click", () => {
            const currentAmp = Number(button.dataset.current);
            setCurrent(currentAmp);
        });
    });
}

async function load() {
    try {
        const res = await fetch("/api/status");
        const data = await res.json();

        document.getElementById("power").innerText = data.power_kw;
        document.getElementById("energy").innerText = data.energy_kwh;
        document.getElementById("temp-type2").innerText = data.type2_temp ?? "-";
        document.getElementById("temp-supply").innerText = data.supply_temp ?? "-";
        const wifiDbm = Number(data.wifi_signal_dbm);
        document.getElementById("wifi-signal").innerText =
            Number.isFinite(wifiDbm) ? wifiDbm.toFixed(0) : "-";
        setWifiBars(wifiDbm);

        const statusEl = document.getElementById("status");
        statusEl.innerText = data.status_text;
        statusEl.className = "badge " + data.status_color;

        document.getElementById("configured-phases").innerText =
            data.configured_phases ? data.configured_phases + "-phase" : "-";
        document.getElementById("configured-current").innerText =
            data.configured_current_amp ?? "-";
        setActiveButton("phase-buttons", "phase", data.configured_phases);
        setActiveButton("current-buttons", "current", data.configured_current_amp);

        for (let i = 0; i < 3; i++) {
            document.getElementById("v" + (i+1)).innerText = data.voltages[i];
            document.getElementById("a" + (i+1)).innerText = data.currents[i];

            const phaseBox = document.getElementById("phase" + (i+1));
            if (parseFloat(data.currents[i]) > 0) {
                phaseBox.classList.add("active");
            } else {
                phaseBox.classList.remove("active");
            }
        }

    } catch (error) {
        console.error(error);
    }
}

setInterval(load, 3000);
bindControlEvents();
load();
</script>

</body>
</html>
